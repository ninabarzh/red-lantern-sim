name: Scenario Validation

on:
  push:
    paths:
      - 'simulator/scenarios/**'
  pull_request:
    paths:
      - 'simulator/scenarios/**'

jobs:
  validate-scenarios:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate YAML syntax
        run: |
          python -c "
          import yaml
          from pathlib import Path

          errors = []
          for scenario_path in Path('simulator/scenarios').rglob('scenario.yaml'):
              try:
                  with open(scenario_path) as f:
                      yaml.safe_load(f)
                  print(f'✅ {scenario_path}')
              except Exception as e:
                  errors.append(f'❌ {scenario_path}: {e}')

          if errors:
              for err in errors:
                  print(err)
              exit(1)
          "

      - name: Run all scenarios
        run: |
          for scenario in simulator/scenarios/**/scenario.yaml; do
            # Use parameter expansion to get the directory name
            scenario_dir=$(dirname "$scenario")
            scenario_name=$(basename "$scenario_dir")
            echo "Running $scenario (scenario: $scenario_name)"
            timeout 120s python -m simulator.cli "$scenario" \
              --output json \
              --json-file "${scenario_name}-output.json" || echo "Warning: Scenario $scenario timed out or failed"
          done

      - name: Validate output format
        run: |
          python -c "
          import json
          from pathlib import Path
          import sys

          errors = []
          for output_file in Path('.').glob('*-output.json'):
              try:
                  with open(output_file) as f:
                      data = json.load(f)

                  if not isinstance(data, list):
                      errors.append(f'{output_file} should be a list, got {type(data)}')
                  elif len(data) == 0:
                      errors.append(f'{output_file} should not be empty')
                  else:
                      for i, event in enumerate(data):
                          if 'line' not in event:
                              errors.append(f'{output_file} event {i} should have line field')
                      
                      if not errors:
                          print(f'✅ {output_file}: {len(data)} events')
              except Exception as e:
                  errors.append(f'{output_file}: {e}')

          if errors:
              for err in errors:
                  print(err)
              sys.exit(1)
          "

      - name: Archive scenario outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scenario-outputs
          path: '*-output.json'
          retention-days: 30