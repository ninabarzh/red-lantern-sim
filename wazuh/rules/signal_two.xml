<!--
  Signal Two: Subprefix Interception Detection Rules

  Detects more-specific prefix announcements with latency anomalies.
  These are stealthy MITM attacks where services keep working.

  Rule Range: 100011-100020
-->

<group name="bgp,signal_two,">

  <!-- Subprefix detection (more-specific than monitored prefixes) -->
  <rule id="100011" level="7">
    <if_sid>100001</if_sid>
    <description>More-specific prefix announced: $(attributes.prefix)</description>
    <group>bgp_subprefix,suspicious,</group>
    <options>no_full_log</options>
  </rule>

  <!-- Latency metrics baseline -->
  <rule id="100012" level="0">
    <field name="event_type">^network\.latency$</field>
    <description>Latency measurement: $(attributes.source_router) â†’ $(attributes.target_router)</description>
    <group>latency_baseline,</group>
  </rule>

  <!-- Latency anomaly (>100ms) -->
  <rule id="100013" level="6">
    <if_sid>100012</if_sid>
    <field name="attributes.latency_ms">^[1-9][0-9]{2,}</field>
    <description>Latency anomaly: $(attributes.latency_ms)ms to $(attributes.target_router)</description>
    <group>latency_anomaly,</group>
  </rule>

  <!-- Severe latency spike (>200ms) -->
  <rule id="100014" level="8">
    <if_sid>100012</if_sid>
    <field name="attributes.latency_ms">^[2-9][0-9]{2,}</field>
    <description>Severe latency spike: $(attributes.latency_ms)ms to $(attributes.target_router)</description>
    <group>latency_severe,suspicious,</group>
  </rule>

  <!-- Packet loss detected -->
  <rule id="100015" level="6">
    <if_sid>100012</if_sid>
    <field name="attributes.packet_loss_pct">[1-9]</field>
    <description>Packet loss detected: $(attributes.packet_loss_pct)% to $(attributes.target_router)</description>
    <group>packet_loss,</group>
  </rule>

  <!-- Jitter anomaly (>10ms) -->
  <rule id="100016" level="5">
    <if_sid>100012</if_sid>
    <field name="attributes.jitter_ms">^[1-9][0-9]</field>
    <description>Jitter anomaly: $(attributes.jitter_ms)ms to $(attributes.target_router)</description>
    <group>jitter_anomaly,</group>
  </rule>

  <!-- Subprefix + latency correlation (within 120s) -->
  <rule id="100017" level="10" frequency="2" timeframe="120">
    <if_matched_sid>100011</if_matched_sid>
    <if_matched_sid>100013</if_matched_sid>
    <description>Subprefix announcement with latency anomaly</description>
    <group>bgp_subprefix_latency,attack,</group>
  </rule>

  <!-- Router event: new route learned -->
  <rule id="100018" level="4">
    <if_sid>100006</if_sid>
    <match>New route learned|route learned</match>
    <description>New route learned: $(attributes.message)</description>
    <group>bgp_new_route,</group>
  </rule>

  <!-- Router event: best path change -->
  <rule id="100019" level="5">
    <if_sid>100006</if_sid>
    <match>Best path|more-specific</match>
    <description>Best path change: $(attributes.message)</description>
    <group>bgp_path_change,</group>
  </rule>

  <!-- HIGH CONFIDENCE: Subprefix + latency + router event -->
  <rule id="100020" level="12" frequency="3" timeframe="300">
    <if_matched_sid>100011</if_matched_sid>
    <if_matched_sid>100013</if_matched_sid>
    <if_matched_sid>100019</if_matched_sid>
    <description>HIGH CONFIDENCE: Subprefix interception in progress</description>
    <group>bgp_interception,high_confidence,attack,</group>
    <options>alert_by_email</options>
  </rule>

</group>