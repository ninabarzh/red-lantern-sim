<!--
  Signal One: Fat-Finger Hijack Detection Rules

  Detects exact-prefix BGP hijacks (origin AS changes without authorisation).
  These are the "oops" scenarios that happen multiple times per year.

  Rule Range: 100000-100010
-->

<group name="bgp,signal_one,">

  <!-- Base rule for BGP events -->
  <rule id="100000" level="0">
    <field name="event_type">^bgp\.</field>
    <description>BGP telemetry event</description>
  </rule>

  <!-- BGP UPDATE detected -->
  <rule id="100001" level="3">
    <if_sid>100000</if_sid>
    <field name="event_type">^bgp\.update$</field>
    <description>BGP UPDATE: $(attributes.prefix) via AS$(attributes.origin_as)</description>
    <group>bgp_update,</group>
  </rule>

  <!-- BGP WITHDRAW detected -->
  <rule id="100002" level="3">
    <if_sid>100000</if_sid>
    <field name="event_type">^bgp\.withdraw$</field>
    <description>BGP WITHDRAW: $(attributes.prefix)</description>
    <group>bgp_withdraw,</group>
  </rule>

  <!-- Origin AS change detection (key signal) -->
  <rule id="100003" level="7">
    <if_sid>100001</if_sid>
    <description>BGP origin AS change detected for $(attributes.prefix)</description>
    <group>bgp_origin_change,suspicious,</group>
    <options>no_full_log</options>
  </rule>

  <!-- Short-lived route (announcement followed by quick withdrawal) -->
  <rule id="100004" level="8" frequency="2" timeframe="600">
    <if_matched_sid>100001</if_matched_sid>
    <same_field>attributes.prefix</same_field>
    <description>Short-lived BGP route: $(attributes.prefix) withdrawn within 10 minutes</description>
    <group>bgp_short_route,suspicious,</group>
  </rule>

  <!-- Fat-finger hijack pattern (UPDATE from unexpected AS + quick withdraw) -->
  <rule id="100005" level="10" frequency="2" timeframe="300">
    <if_matched_sid>100001</if_matched_sid>
    <if_matched_sid>100002</if_matched_sid>
    <same_field>attributes.prefix</same_field>
    <description>Fat-finger hijack pattern: $(attributes.prefix) announced and withdrawn quickly</description>
    <group>bgp_hijack,attack,</group>
  </rule>

  <!-- Router syslog correlation -->
  <rule id="100006" level="5">
    <field name="event_type">^router\.syslog$</field>
    <match>BGP session</match>
    <description>Router BGP event: $(attributes.message)</description>
    <group>router_bgp,</group>
  </rule>

  <!-- BGP session reset (often accompanies hijacks) -->
  <rule id="100007" level="6">
    <if_sid>100006</if_sid>
    <match>reset|flapped</match>
    <description>BGP session reset on $(attributes.router): $(attributes.peer_ip)</description>
    <group>bgp_session_reset,</group>
  </rule>

  <!-- Prefix limit exceeded -->
  <rule id="100008" level="7">
    <if_sid>100006</if_sid>
    <match>Prefix limit.*exceeded</match>
    <description>Prefix limit exceeded on $(attributes.router): $(attributes.peer_ip)</description>
    <group>bgp_prefix_limit,suspicious,</group>
  </rule>

  <!-- Composite: BGP change + router event within 60s -->
  <rule id="100009" level="9" frequency="2" timeframe="60">
    <if_matched_sid>100003</if_matched_sid>
    <if_matched_sid>100007</if_matched_sid>
    <description>Correlated BGP hijack indicators: route change + session reset</description>
    <group>bgp_hijack_correlated,attack,</group>
  </rule>

  <!-- High-frequency announcements (BGP spam) -->
  <rule id="100010" level="8" frequency="10" timeframe="300">
    <if_matched_sid>100001</if_matched_sid>
    <same_field>attributes.origin_as</same_field>
    <description>High-frequency BGP announcements from AS$(attributes.origin_as)</description>
    <group>bgp_spam,suspicious,</group>
  </rule>

</group>